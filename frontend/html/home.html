{% extends 'base.html' %}
{% load static %}

{% block title %}Home page{% endblock %}

{% block links %}
<link rel="stylesheet" href="{% static 'css/home.css' %}" />
<link rel="stylesheet" href="{% static 'css/create_task.css' %}" />
{% endblock %}

{% block content %}

<!-- Модалка для відправки на рев’ю -->
<div id="taskModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Send to Review</h3>

    <form method="post" enctype="multipart/form-data" id="review-form">
      {% csrf_token %}
      {{ review_form.as_p }}
      <button type="submit" class="btn-submit">✅ Send</button>
    </form>
  </div>
</div>

<!-- Список тасків -->
<div class="list-container">
    {% for t in tasks %}
    <div class="task-item{% if t.is_archived %} archived{% elif t.is_completed %} completed{% endif %}">
        <div class="task-content">
            <h3>{{ t.title }}</h3>
            <p>{{ t.description }}</p>
            <p>Created at: {{ t.created_at }}</p>
            <p class="{% if t.due_status == 'overdue' %}due-overdue{% elif t.due_status == 'soon' %}due-soon{% elif t.due_status == 'no_date' %}due-no-date{% endif %}">
                Due Date: {{ t.due_date|date:"Y-m-d H:i" }}
            </p>
            <p>Priority: {{ t.priority }}</p>
            <p>Created by: {{ t.created_by.username }}</p>
            <p>
                Assigned to: 
                {% for u in t.for_who.all %}
                    {{ u.username }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                    nobody
                {% endfor %}
            </p>
        </div>
        <a href="#" class="open-review-modal" data-task-id="{{ t.id }}">📤 Send to Review</a>
    </div>
    {% empty %}
    <p>No tasks available.</p>
    {% endfor %}
</div>

<!-- JS для модалки -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("taskModal");
    const closeBtn = modal.querySelector(".close");
    const form = document.getElementById("review-form");

    if (!form) {
        console.error("Form not found!");
        return;
    }

    document.querySelectorAll(".open-review-modal").forEach(btn => {
        btn.addEventListener("click", function (e) {
            e.preventDefault();
            const taskId = this.dataset.taskId;
            console.log("Clicked taskId:", taskId); // <- перевірка

            if (!taskId) {
                console.error("taskId is undefined!");
                return;
            }

            // Встановлюємо правильний action
            form.setAttribute("action", `/tasks/send-to-review/${taskId}/`);
            console.log("Form action set to:", form.getAttribute("action"));

            modal.style.display = "flex";
        });
    });

    closeBtn.addEventListener("click", () => {
        modal.style.display = "none";
    });

    window.addEventListener("click", (e) => {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });
});

</script>

{% endblock %}
